---
- name: Deploy Tail Number Lookup Application
  hosts: all
  become: yes
  vars:
    app_name: tailnumberlookup
    app_user: ansible
    app_directory: "{{ app_directory | default('/opt/tailnumberlookup') }}"
    api_port: "{{ api_port | default(49080) }}"
    deploy_env: "{{ deploy_env | default('prod') }}"
    service_name: "faa-api-{{ deploy_env }}"
    sync_service_name: "faa-sync-{{ deploy_env }}"
    python_version: "3"
    
  tasks:
    - name: Check if Python 3 is installed
      command: which python3
      register: python3_check
      changed_when: false
      failed_when: false
    
    - name: Check if pip3 is installed
      command: which pip3
      register: pip3_check
      changed_when: false
      failed_when: false
    
    - name: Install Python 3 and pip
      package:
        name:
          - python3
          - python3-pip
          - python3-venv
        state: present
      when: python3_check.rc != 0 or pip3_check.rc != 0
    
    - name: Create application directory
      file:
        path: "{{ app_directory }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'
    
    - name: Create data directory
      file:
        path: "{{ app_directory }}/data"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'
    
    - name: Copy application files
      synchronize:
        src: "{{ playbook_dir }}/../"
        dest: "{{ app_directory }}/"
        delete: yes
        rsync_opts:
          - "--exclude=.git"
          - "--exclude=.env"
          - "--exclude=data"
          - "--exclude=venv"
          - "--exclude=__pycache__"
          - "--exclude=*.pyc"
          - "--exclude=*.pyo"
          - "--exclude=.DS_Store"
          - "--exclude=ansible/.vault_pass"
          - "--exclude=*.db"
          - "--exclude=*.db-journal"
          - "--exclude=FAA_Database"
          - "--exclude=ReleasableAircraft.zip"
      become_user: "{{ app_user }}"
    
    - name: Create Python virtual environment
      command: python3 -m venv "{{ app_directory }}/venv"
      args:
        creates: "{{ app_directory }}/venv/bin/activate"
      become_user: "{{ app_user }}"
    
    - name: Install Python dependencies
      pip:
        requirements: "{{ app_directory }}/requirements.txt"
        executable: "{{ app_directory }}/venv/bin/pip"
      become_user: "{{ app_user }}"
    
    - name: Ensure data directory exists
      file:
        path: "{{ app_directory }}/data"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'
    
    - name: Initialize database
      command: "{{ app_directory }}/venv/bin/python -m backend.sync.database"
      args:
        chdir: "{{ app_directory }}"
      environment:
        PYTHONPATH: "{{ app_directory }}"
      become_user: "{{ app_user }}"
      ignore_errors: yes
      changed_when: false
    
    - name: Verify database file exists
      stat:
        path: "{{ app_directory }}/data/faa_aircraft.db"
      register: db_file
    
    - name: Fail if database not created
      fail:
        msg: "Database file was not created. Check logs for errors."
      when: not db_file.stat.exists
    
    - name: Copy systemd service file for API server
      template:
        src: faa-api.service.j2
        dest: /etc/systemd/system/{{ service_name }}.service
        mode: '0644'
      notify: reload systemd
    
    - name: Copy systemd service file for sync
      template:
        src: faa-sync.service.j2
        dest: /etc/systemd/system/{{ sync_service_name }}.service
        mode: '0644'
      notify: reload systemd
    
    - name: Copy systemd timer file for sync
      template:
        src: faa-sync.timer.j2
        dest: /etc/systemd/system/{{ sync_service_name }}.timer
        mode: '0644'
      notify: reload systemd
    
    - name: Stop old API service if it exists (cleanup)
      systemd:
        name: "{{ service_name }}"
        state: stopped
      ignore_errors: yes
    
    - name: Enable and start API service
      systemd:
        name: "{{ service_name }}"
        enabled: yes
        state: started
        daemon_reload: yes
    
    - name: Enable and start sync timer
      systemd:
        name: "{{ sync_service_name }}.timer"
        enabled: yes
        state: started
        daemon_reload: yes
    
    - name: Check API service status
      systemd:
        name: "{{ service_name }}"
      register: api_status
    
    - name: Display API service status
      debug:
        msg: "API service {{ service_name }} is {{ api_status.status.ActiveState }}"
  
  handlers:
    - name: reload systemd
      systemd:
        daemon_reload: yes

